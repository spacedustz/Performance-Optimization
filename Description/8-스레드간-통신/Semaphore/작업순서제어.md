## ğŸ“š Semaphore - Multi Threading ì‘ì—… ìˆœì„œ ì œì–´ & ë™ê¸°í™”

ë©€í‹°ì“°ë ˆë“œ í™˜ê²½ì—ì„œ ì—¬ëŸ¬ ì“°ë ˆë“œê°€ í˜‘ë ¥í•˜ì—¬ ìˆœì°¨ì ìœ¼ë¡œ ì‘ì—…ì„ ì²˜ë¦¬í•´ì•¼ í•  ë•Œ, **ë™ê¸°í™”(Synchronization)**ëŠ” ë§¤ìš° ì¤‘ìš”í•©ë‹ˆë‹¤. 

ì´ë²ˆ ê¸€ì—ì„œëŠ” Semaphoreì™€ Custom Barrier í´ë˜ìŠ¤ë¥¼ í™œìš©í•˜ì—¬ 

`ëª¨ë“  ì“°ë ˆë“œë“¤ì´ ì²« ë²ˆì§¸ ì‘ì—…ì„ ì „ë¶€ ì™„ë£Œí•  ë–„ ê¹Œì§€ Semaphoreë¥¼ ì´ìš©í•´ Blocking` ì‹œí‚¤ê³  ì´í›„ `ë‘ ë²ˆì§¸ ì‘ì—…ì„ ìˆ˜í–‰`í•˜ë„ë¡ ë™ê¸°í™”í•˜ëŠ” ë°©ë²•ì„ ì‘ì„± í•˜ê² ìŠµë‹ˆë‹¤.

<br>

ì˜ˆì‹œë¡œ êµ¬í˜„í•  ë¡œì§ì€ ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤.

- 20ê°œì˜ Threadë¡œ ì§„í–‰
- ì‘ì—… 1ê³¼ 2ê°€ ìˆê³  20ê°œì˜ Threadê°€ ì‘ì—… 1ì„ ëª¨ë‘ ì™„ë£Œí•œ ìƒíƒœê°€ ì•„ë‹ˆë©´ ì‘ì—… 2ë¡œ ë„˜ì–´ê°€ì§€ ì•ŠìŒ
- ê° ì‘ì—… ë‹¹ Threadë“¤ì˜ ì‹¤í–‰ ìˆœì„œëŠ” ì¤‘ìš”í•˜ì§€ ì•Šê³  `20ê°œì˜ Thread ëª¨ë‘ ì‘ì—… 1ì´ ì™„ë£Œ` ëœ í›„ì—ë§Œ ì‘ì—… 2ë¡œ ë„˜ì–´ê°€ê¸°


---

## ğŸ“š Barrier Class (Shared Resource)

20ê°œì˜ Threadë“¤ì´ ê³µí†µìœ¼ë¡œ ì‚¬ìš©í•  ê³µìš© ë¦¬ì†ŒìŠ¤ì¸ Barrier í´ë˜ìŠ¤ì…ë‹ˆë‹¤.

<br>

**Semaphore**

- 0ìœ¼ë¡œ ì´ˆê¸°í™”ë¥¼ í•´ì„œ ë‹¤ë¥¸ Threadì—ì„œ acquire()ë¥¼ í˜¸ì¶œí•´ë„ ëŒ€ê¸°ìƒíƒœë¡œ Blocking ì‹œí‚´
- ğŸ§™â€â™€ï¸ **SemaphoreëŠ” ReentrantLockê³¼ ë‹¤ë¥´ê²Œ ë‹¤ë¥¸ Threadì—ì„œ release()ë¥¼ í˜¸ì¶œí•˜ëŠ” ê²ƒì´ ê°€ëŠ¥í•˜ë‹¤ëŠ”ê±¸ ê¸°ì–µí•˜ê¸°**

<br>

**counter ê°’**

- ê° Threadê°€ ì‘ì—…ì„ ìˆ˜í–‰ í›„ ìµœëŒ€ Thread ìˆ˜ì— ë„ë‹¬í•  ë•Œ ê¹Œì§€ counterë¥¼ ì¦ê°€ì‹œí‚µë‹ˆë‹¤.
- counterë¥¼ ê³„ì† ì¦ê°€ ì‹œí‚¤ë‹¤ê°€ counterì˜ ê°’ì´ numberOfWorkersì™€ ë™ì¼í•´ì§€ë©´ (ë§ˆì§€ë§‰ Threadì˜ ì‘ì—… ì°¨ë¡€ê°€ ì˜¤ë©´) Semaphoreë¥¼ 19ê°œ release í•©ë‹ˆë‹¤.
- releaseëœ 19ê°œì˜ ThreadëŠ” ëª¨ë‘ ì‘ì—…1ì´ ì™„ë£Œëœ ìƒíƒœì´ë¯€ë¡œ ë‹¤ìŒ ì‘ì—…ì¸ ì‘ì—…2ë¡œ ë„˜ì–´ê°‘ë‹ˆë‹¤.
- ë§ˆì§€ë§‰ Threadì˜ ì‘ì—…ì´ ì¢…ë£Œ ëœ í›„ ì‘ì—… 2ì˜ ì‹œì‘ì„ ì•Œë¦¬ê¸° ìœ„í•´ `========== ì‘ì—… ë ==========` ë¬¸ìì—´ì„ ì¶œë ¥ í•´ì£¼ì—ˆìŠµë‹ˆë‹¤.
- ğŸ§™â€â™€ï¸ ì™œ release()ë¥¼ 19ê°œë§Œ í˜¸ì¶œí•˜ëƒ? => ë§ˆì§€ë§‰ ThreadëŠ” acquire()ë¡œ ëŒ€ê¸°ì¤‘ì¸ ìŠ¤ë ˆë“œê°€ ì•„ë‹ˆê¸° ë•Œë¬¸ì— ì‘ì—…ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.

<br>

**ReentrantLock**

- 20ê°œì˜ Threadë“¤ì´ Barrierì— ë“¤ì–´ì™€ì„œ counter ê°’ì„ ì¦ê°€ì‹œí‚¤ëŠ” ì‘ì—…ì˜ Race Condition ë°©ì§€ë¥¼ ìœ„í•´ `waitForOthers()` í•¨ìˆ˜ì˜ counter ê°’ì„ ì¦ê°€ ì‹œí‚¤ëŠ” ë¡œì§ì— ì— ì„ê³„ ì˜ì—­ ì³ì£¼ê¸° 

<br>

**Barrier Class**

```java
public class Barrier {
    private final int numberOfWorkers;
    private final Semaphore semaphore = new Semaphore(0); // ì²˜ìŒì—ëŠ” 0ìœ¼ë¡œ ì‹œì‘, ëª¨ë“  ì“°ë ˆë“œ ëŒ€ê¸°
    private int counter = 0; // ì‘ì—…ì„ ì™„ë£Œí•œ ì“°ë ˆë“œ ìˆ˜ ì¶”ì 
    private final Lock lock = new ReentrantLock();

    public Barrier(int numberOfWorkers) {
        this.numberOfWorkers = numberOfWorkers;
    }

    // ì²«ë²ˆì§¸ Threadê°€ ì‘ì—… ì™„ë£Œ í›„ ë‚˜ë¨¸ì§€ ëª¨ë“  ìŠ¤ë ˆë“œë“¤ì„ ê¸°ë‹¤ë¦¬ê³ , ë‚˜ë¨¸ì§€ ëª¨ë“  ìŠ¤ë ˆë“œê°€ ì‘ì—… 1ì„ ì™„ë£Œí–ˆìœ¼ë©´ ì „ë¶€ ê¹¨ì›Œì„œ ì‘ì—… 2 ìˆ˜í–‰
    public void waitForOthers() throws InterruptedException {
        lock.lock();
        boolean isLastWorker = false;
        try {
            counter++;
            if (counter == numberOfWorkers) {
                isLastWorker = true; // ë§ˆì§€ë§‰ ì“°ë ˆë“œì¸ì§€ í™•ì¸
            }
        } finally {
            lock.unlock();
        }

        if (isLastWorker) {
            semaphore.release(numberOfWorkers - 1); // ë§ˆì§€ë§‰ ì“°ë ˆë“œëŠ” ëª¨ë“  ë‹¤ë¥¸ ì“°ë ˆë“œë¥¼ ê¹¨ì›€
            System.out.println("==================== ì‘ì—… ë ====================");
        } else {
            semaphore.acquire(); // ë‹¤ë¥¸ ì“°ë ˆë“œëŠ” ëŒ€ê¸°
        }
    }
}
```

---

## ğŸ“š Worker Thread

ì‹¤ì œë¡œ ì‘ì—…ì„ ìˆ˜í–‰í•  Threadë¥¼ êµ¬í˜„í•©ë‹ˆë‹¤.

Barrier í´ë˜ìŠ¤ë¥¼ ë©¤ë²„ë¡œ ê°€ì§€ê³  ìˆê³ , ë‹¤ë¥¸ Threadë“¤ì„ ê¸°ë‹¤ë¦¬ê¸° ìœ„í•´ **ë™ê¸°í™”ëœ ì§€ì ì„ ì„¤ì •**í•˜ëŠ”ë° ì´ Barrier í´ë˜ìŠ¤ë¥¼ ì´ìš©í•©ë‹ˆë‹¤.

ê·¸ë¦¬ê³  ë‹¨ìˆœíˆ `task()` í•¨ìˆ˜ì—ì„œ ì½˜ì†” ì¶œë ¥ ì‘ì—…ì¸ ì‘ì—… 1,2ë¥¼ ìˆ˜í–‰ í•˜ëŠ”ë°,

ëª¨ë“  ìŠ¤ë ˆë“œê°€ ì‘ì—… 1ì„ ìš°ì„  ì™„ë£Œí•˜ê³  Barrier í´ë˜ìŠ¤ì˜ `waitForOthers()`ë¡œ ë‹¤ë¥¸ Threadê°€ ëª¨ë‘ ì‘ì—… 1ì„ ì™„ë£Œí•  ë•Œê¹Œì§€ ëŒ€ê¸° í›„ ì‘ì—… 2ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.

**Worker Thread**

```java
public class CoordinatedWorkRunner implements Runnable {
    private final Barrier barrier;

    public CoordinatedWorkRunner(Barrier barrier) {
        this.barrier = barrier;
    }

    @Override
    public void run() {
        try {
            task();
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
    }

    private void task() throws InterruptedException {
        // ì²« ë²ˆì§¸ ì‘ì—… ìˆ˜í–‰
        System.out.println(Thread.currentThread().getName()
                + " ì‘ì—… 1 ìˆ˜í–‰");

        barrier.waitForOthers(); // ë‹¤ë¥¸ ì“°ë ˆë“œë“¤ì´ ë„ì°©í•  ë•Œê¹Œì§€ ëŒ€ê¸°

        // ë‘ ë²ˆì§¸ ì‘ì—… ìˆ˜í–‰
        System.out.println(Thread.currentThread().getName()
                + " ì‘ì—… 2 ìˆ˜í–‰");
    }
}
```

---

## ğŸ“š ì‹¤í–‰ í•´ë³´ê¸°

ì´ì œ Threadì™€ Barrierë¥¼ ë§Œë“¤ì—ˆìœ¼ë‹ˆ ì‹¤í–‰ í•´ë³´ê² ìŠµë‹ˆë‹¤.

Threadì˜ ê°œìˆ˜ëŠ” 20ê°œë¡œ ë§Ÿì¶”ê³  ë‹¨ìˆœíˆ Forë¬¸ì„ ëŒë©° ëª¨ë“  Threadë¥¼ ì‹¤í–‰ ì‹œí‚µë‹ˆë‹¤.

ì•„ë˜ ê²°ê³¼ê°’ì„ ë³´ë©´ Semaphoreë¥¼ ì´ìš©í•´ ì—¬ëŸ¬ Threadë“¤ì„ ë™ê¸°í™” í•´ì„œ ì‘ì—… ìˆœì„œ ì œì–´ì— ì„±ê³µ í•˜ì˜€ìŠµë‹ˆë‹¤.

ì‹¤ì œ ì½”ë“œë¥¼ ë¸”ë¡œê·¸ì— ì ì„ ìˆœ ì—†ìœ¼ë‹ˆ ê°„ë‹¨í•œ ì˜ˆì‹œë¥¼ ë§Œë“¤ì–´ ë©€í‹°ìŠ¤ë ˆë”© í™˜ê²½ì—ì„œì˜ ì‘ì—… ìˆœì„œ ì œì–´ë¥¼ êµ¬í˜„í•´ë³´ì•˜ìŠµë‹ˆë‹¤.

```java
public class SemaphoreBarrier {
    public static void main(String [] args) throws InterruptedException {
        int numberOfThreads = 20;

        List<Thread> threads = new ArrayList<>();

        // ê³µìœ  ìì›- > ëª¨ë“  ìŠ¤ë ˆë“œê°€ ì´ Barrier ê°ì²´ë¥¼ ê°€ì§€ë©° ë‚´ë¶€ counter ê°’ìœ¼ë¡œ Semaphoreë¥¼ í†µí•´ Thread Blockingì´ ì¼ì–´ë‚¨
        Barrier barrier = new Barrier(numberOfThreads);

        for (int i = 0; i < numberOfThreads; i++) {
            threads.add(new Thread(new CoordinatedWorkRunner(barrier)));
        }

        for(Thread thread: threads) {
            thread.start();
        }
    }
}
```

<br>

**ê²°ê³¼ê°’**

```
> Task :SemaphoreBarrier.main()
Thread-4 ì‘ì—… 1 ìˆ˜í–‰
Thread-3 ì‘ì—… 1 ìˆ˜í–‰
Thread-5 ì‘ì—… 1 ìˆ˜í–‰
Thread-14 ì‘ì—… 1 ìˆ˜í–‰
Thread-6 ì‘ì—… 1 ìˆ˜í–‰
Thread-11 ì‘ì—… 1 ìˆ˜í–‰
Thread-1 ì‘ì—… 1 ìˆ˜í–‰
Thread-2 ì‘ì—… 1 ìˆ˜í–‰
Thread-10 ì‘ì—… 1 ìˆ˜í–‰
Thread-0 ì‘ì—… 1 ìˆ˜í–‰
Thread-17 ì‘ì—… 1 ìˆ˜í–‰
Thread-13 ì‘ì—… 1 ìˆ˜í–‰
Thread-19 ì‘ì—… 1 ìˆ˜í–‰
Thread-18 ì‘ì—… 1 ìˆ˜í–‰
Thread-16 ì‘ì—… 1 ìˆ˜í–‰
Thread-7 ì‘ì—… 1 ìˆ˜í–‰
Thread-15 ì‘ì—… 1 ìˆ˜í–‰
Thread-12 ì‘ì—… 1 ìˆ˜í–‰
Thread-9 ì‘ì—… 1 ìˆ˜í–‰
Thread-8 ì‘ì—… 1 ìˆ˜í–‰
==================== ì‘ì—… ë ====================
Thread-4 ì‘ì—… 2 ìˆ˜í–‰
Thread-2 ì‘ì—… 2 ìˆ˜í–‰
Thread-0 ì‘ì—… 2 ìˆ˜í–‰
Thread-13 ì‘ì—… 2 ìˆ˜í–‰
Thread-7 ì‘ì—… 2 ìˆ˜í–‰
Thread-3 ì‘ì—… 2 ìˆ˜í–‰
Thread-8 ì‘ì—… 2 ìˆ˜í–‰
Thread-18 ì‘ì—… 2 ìˆ˜í–‰
Thread-16 ì‘ì—… 2 ìˆ˜í–‰
Thread-6 ì‘ì—… 2 ìˆ˜í–‰
Thread-1 ì‘ì—… 2 ìˆ˜í–‰
Thread-11 ì‘ì—… 2 ìˆ˜í–‰
Thread-9 ì‘ì—… 2 ìˆ˜í–‰
Thread-15 ì‘ì—… 2 ìˆ˜í–‰
Thread-5 ì‘ì—… 2 ìˆ˜í–‰
Thread-19 ì‘ì—… 2 ìˆ˜í–‰
Thread-17 ì‘ì—… 2 ìˆ˜í–‰
Thread-10 ì‘ì—… 2 ìˆ˜í–‰
Thread-14 ì‘ì—… 2 ìˆ˜í–‰
Thread-12 ì‘ì—… 2 ìˆ˜í–‰
```

<br>

**ì „ì²´ ì½”ë“œ**

```java
public class SemaphoreBarrier {
    public static void main(String [] args) throws InterruptedException {
        int numberOfThreads = 20;

        List<Thread> threads = new ArrayList<>();

        // ê³µìœ  ìì›- > ëª¨ë“  ìŠ¤ë ˆë“œê°€ ì´ Barrier ê°ì²´ë¥¼ ê°€ì§€ë©° ë‚´ë¶€ counter ê°’ìœ¼ë¡œ Semaphoreë¥¼ í†µí•´ Thread Blockingì´ ì¼ì–´ë‚¨
        Barrier barrier = new Barrier(numberOfThreads);

        for (int i = 0; i < numberOfThreads; i++) {
            threads.add(new Thread(new CoordinatedWorkRunner(barrier)));
        }

        for(Thread thread: threads) {
            thread.start();
        }
    }
    
    static class Barrier {
        private final int numberOfWorkers;
        private final Semaphore semaphore = new Semaphore(0); // ì²˜ìŒì—ëŠ” 0ìœ¼ë¡œ ì‹œì‘, ëª¨ë“  ì“°ë ˆë“œ ëŒ€ê¸°
        private int counter = 0; // ì‘ì—…ì„ ì™„ë£Œí•œ ì“°ë ˆë“œ ìˆ˜ ì¶”ì 
        private final Lock lock = new ReentrantLock();

        public Barrier(int numberOfWorkers) {
            this.numberOfWorkers = numberOfWorkers;
        }

        // ì²«ë²ˆì§¸ Threadê°€ ì‘ì—… ì™„ë£Œ í›„ ë‚˜ë¨¸ì§€ ëª¨ë“  ìŠ¤ë ˆë“œë“¤ì„ ê¸°ë‹¤ë¦¬ê³ , ë‚˜ë¨¸ì§€ ëª¨ë“  ìŠ¤ë ˆë“œê°€ ì‘ì—… 1ì„ ì™„ë£Œ í–ˆìœ¼ë©´ ê·¸ë–„ ì „ë¶€ êº ì›Œì„œ ì‘ì—… 2 ìˆ˜í–‰
        public void waitForOthers() throws InterruptedException {
            lock.lock();
            boolean isLastWorker = false;
            try {
                counter++;
                if (counter == numberOfWorkers) {
                    isLastWorker = true; // ë§ˆì§€ë§‰ ì“°ë ˆë“œì¸ì§€ í™•ì¸
                }
            } finally {
                lock.unlock();
            }

            if (isLastWorker) {
                semaphore.release(numberOfWorkers - 1); // ë§ˆì§€ë§‰ ì“°ë ˆë“œëŠ” ëª¨ë“  ë‹¤ë¥¸ ì“°ë ˆë“œë¥¼ ê¹¨ì›€
                System.out.println("==================== ì‘ì—… ë ====================");
            } else {
                semaphore.acquire(); // ë‹¤ë¥¸ ì“°ë ˆë“œëŠ” ëŒ€ê¸°
            }
        }
    }
    
    static class CoordinatedWorkRunner implements Runnable {
        private final Barrier barrier;

        public CoordinatedWorkRunner(Barrier barrier) {
            this.barrier = barrier;
        }

        @Override
        public void run() {
            try {
                task();
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
            }
        }

        private void task() throws InterruptedException {
            // ì²« ë²ˆì§¸ ì‘ì—… ìˆ˜í–‰
            System.out.println(Thread.currentThread().getName()
                    + " ì‘ì—… 1 ìˆ˜í–‰");

            barrier.waitForOthers(); // ë‹¤ë¥¸ ì“°ë ˆë“œë“¤ì´ ë„ì°©í•  ë•Œê¹Œì§€ ëŒ€ê¸°

            // ë‘ ë²ˆì§¸ ì‘ì—… ìˆ˜í–‰
            System.out.println(Thread.currentThread().getName()
                    + " ì‘ì—… 2 ìˆ˜í–‰");
        }
    }
}
```